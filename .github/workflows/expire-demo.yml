name: Expire Demo Repository

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  administration: write

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine expiration
        id: expiry
        run: |
          set -euo pipefail
          line="$(grep -F 'EXPIRATION:' deploy_all.sql | head -n 1 || true)"
          expires="$(echo "$line" | sed -nE 's/.*EXPIRATION:[[:space:]]*([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/p')"
          if [[ -z "$expires" ]]; then
            echo "Failed to determine expiration date from deploy_all.sql header." >&2
            echo "Expected a line like: * EXPIRATION: YYYY-MM-DD" >&2
            exit 1
          fi
          today="$(date -u +%F)"
          echo "expires=$expires" >> "$GITHUB_OUTPUT"
          echo "today=$today" >> "$GITHUB_OUTPUT"
          if [[ "$today" == "$expires" || "$today" > "$expires" ]]; then
            echo "expired=true" >> "$GITHUB_OUTPUT"
          else
            echo "expired=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Archive repository when expired
        if: steps.expiry.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh api -X PATCH "repos/${{ github.repository }}" -f archived=true -f visibility=private
