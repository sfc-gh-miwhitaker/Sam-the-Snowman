name: Auto-Archive Demo on Expiration

# This workflow automatically archives and makes the repository private
# after the demo expiration date (30 days from creation).
#
# Expiration date: 2025-12-25
# Rationale: Prevents outdated demo code with deprecated syntax from being
# discovered and used in production after Snowflake features evolve.

on:
  schedule:
    # Run daily at 00:00 UTC to check expiration status
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Check if demo has expired
        id: check_date
        run: |
          # Demo expiration date (YYYY-MM-DD)
          EXPIRATION_DATE="2025-12-25"
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRATION_DATE"
          
          # Convert dates to seconds since epoch for comparison
          EXPIRATION_SECONDS=$(date -d "$EXPIRATION_DATE" +%s)
          CURRENT_SECONDS=$(date -d "$CURRENT_DATE" +%s)
          
          if [ $CURRENT_SECONDS -gt $EXPIRATION_SECONDS ]; then
            echo "Demo has expired. Proceeding with archival."
            echo "expired=true" >> $GITHUB_OUTPUT
          else
            DAYS_REMAINING=$(( ($EXPIRATION_SECONDS - $CURRENT_SECONDS) / 86400 ))
            echo "Demo is still valid. Days remaining: $DAYS_REMAINING"
            echo "expired=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Archive and make repository private
        if: steps.check_date.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Archive the repository
          gh repo archive ${{ github.repository }} --yes
          
          # Make the repository private
          gh repo edit ${{ github.repository }} --visibility private
          
          echo "âœ… Repository has been archived and made private due to expiration."
      
      - name: Send expiration notification
        if: steps.check_date.outputs.expired == 'true'
        run: |
          echo "::warning::Demo repository ${{ github.repository }} has expired and been archived."
          echo "::notice::Expiration date was 2025-12-25. Repository is now private and archived."

