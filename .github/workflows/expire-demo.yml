name: Expire Demo Repository

on:
  schedule:
    - cron: "17 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - name: Determine expiration
        id: expiry
        run: |
          set -euo pipefail
          expires="$(grep -E '^\\!\\[Expires\\]\\(https://img\\.shields\\.io/badge/Expires-' README.md | sed -E 's/.*Expires-([0-9]{4})--([0-9]{2})--([0-9]{2}).*/\\1-\\2-\\3/')"
          today="$(date -u +%F)"
          echo "expires=$expires" >> "$GITHUB_OUTPUT"
          echo "today=$today" >> "$GITHUB_OUTPUT"
          if [ "$today" \> "$expires" ] || [ "$today" = "$expires" ]; then
            echo "expired=true" >> "$GITHUB_OUTPUT"
          else
            echo "expired=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Archive repository when expired
        if: steps.expiry.outputs.expired == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh api -X PATCH "repos/${{ github.repository }}" -f archived=true -f visibility=private
