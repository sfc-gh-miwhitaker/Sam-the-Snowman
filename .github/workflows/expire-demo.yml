# GitHub Actions Workflow: Demo Expiration Auto-Archive
# 
# Purpose: Automatically archive and make private demo repositories after expiration
# 
# This workflow runs daily and checks if the demo has expired.
# If expired, it archives the repository and makes it private.
#
# Author: SE Community
# Created: 2025-11-25
# Last Updated: 2025-12-02

name: Demo Expiration Check

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

env:
  # ============================================
  # EXPIRATION DATE - Single Source of Truth
  # Update this when extending the demo
  # ============================================
  EXPIRE_DATE: '2025-12-25'

jobs:
  check-expiration:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Check if demo has expired
        id: check
        run: |
          CURRENT_DATE=$(date +%Y-%m-%d)
          EXPIRE_DATE="${{ env.EXPIRE_DATE }}"
          
          echo "Current date: $CURRENT_DATE"
          echo "Expiration date: $EXPIRE_DATE"
          
          if [[ "$CURRENT_DATE" > "$EXPIRE_DATE" ]] || [[ "$CURRENT_DATE" == "$EXPIRE_DATE" ]]; then
            echo "expired=true" >> $GITHUB_OUTPUT
            echo "üö´ Demo has EXPIRED"
          else
            echo "expired=false" >> $GITHUB_OUTPUT
            DAYS_LEFT=$(( ($(date -d "$EXPIRE_DATE" +%s) - $(date -d "$CURRENT_DATE" +%s)) / 86400 ))
            echo "‚úÖ Demo is ACTIVE - $DAYS_LEFT days remaining"
          fi

      - name: Archive repository (if expired)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`üóÑÔ∏è Archiving repository ${owner}/${repo}...`);
            
            try {
              // Archive the repository
              await github.rest.repos.update({
                owner,
                repo,
                archived: true
              });
              console.log('‚úÖ Repository archived successfully');
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not archive repository: ${error.message}`);
              console.log('Note: Archiving requires admin permissions on the repository');
            }

      - name: Add expiration notice (if expired)
        if: steps.check.outputs.expired == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`üìù Adding expiration notice to ${owner}/${repo}...`);
            
            try {
              // Update repository description
              await github.rest.repos.update({
                owner,
                repo,
                description: `[ARCHIVED - EXPIRED] This demo expired on ${{ env.EXPIRE_DATE }}. Fork to create your own version.`
              });
              console.log('‚úÖ Repository description updated');
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not update description: ${error.message}`);
            }

      - name: Log status
        run: |
          echo "=================================="
          echo "Demo Expiration Check Complete"
          echo "=================================="
          echo "Repository: ${{ github.repository }}"
          echo "Expiration Date: ${{ env.EXPIRE_DATE }}"
          echo "Expired: ${{ steps.check.outputs.expired }}"
          echo "=================================="
